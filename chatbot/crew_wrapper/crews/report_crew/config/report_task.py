from textwrap import dedent

from crewai import Task


def create_report_task(
    agent,
    user_input: dict,
    recommend_task: str,
    web_search_task: str,
    compare_task: str,
    strategy_task: str,
) -> Task:
    """
    최종 보고서 생성을 위한 Task 생성 함수
    이전 Task들의 output을 받아 종합 보고서를 생성.
    """
    original_input = user_input["original_input"]
    profile = user_input["user_profile"]

    profile_str = "\n".join([f"- {k}: {v}" for k, v in profile.items()])

    return Task(
        description=dedent(
            f"""
        사용자의 질문과 조건을 바탕으로 추천된 정책들을 비교 및 전략적으로 분석한 결과를 종합하여
        최종 보고서를 생성하세요.

        -------------------------
        사용자 질문:
        {original_input}

        사용자 프로필:
        {profile_str}

        추천된 정책 리스트:
        1. RAG 검색 결과:
        {recommend_task}

        2. WEB 검색 결과:
        {web_search_task}

        정책 비교 분석 결과:
        {compare_task}

        추천된 정책의 실행 순서 또는 활용 전략 결과:
        {strategy_task}
        -------------------------

        요청사항:
        - 아래 항목을 모두 포함해 공공서비스 활용 전략 보고서를 구성해 주세요:
        1. 사용자 질문 및 프로필 요약
        2. 추천된 정책 리스트
        3. 정책 비교 분석 표 및 추천 이유
        4. 각 정책별 상세 분석
        5. 실행 전략 (신청 순서 및 근거)
        6. 신청 조건 요약표
        7. 결론 및 마무리 조언

        - 말투는 전문적이되 너무 딱딱하지 않게, 친절하고 쉽게 작성해 주세요.
        - 마크다운 구문(`#`, `##`, `**`, `|`, `[]()`)을 적극 활용해 시각적으로 명확하게 표현해 주세요.
        - 정책명, 조건, 숫자 등 중요한 정보는 **굵게**, 신청 링크는 `[신청 바로가기](https://...)` 형식으로 작성하세요.
        - 사용자가 복사하거나 출력해서 직접 활용할 수 있도록, **문서 형태의 보고서**처럼 완성도 있게 구성해 주세요.
        """
        ),
        expected_output=dedent(
            """
        아래 형식을 참고하여 사용자 맞춤형 공공정책 전략 보고서를 작성해 주세요.

        요구사항:
        - 전체 보고서는 마크다운 문서 형식으로 구성
        - 주요 제목은 `#`, `##`, 소제목은 `###`를 사용해 구분
        - 중요한 정보(정책명, 조건, 금액 등)는 **굵게**, 링크는 `[신청 바로가기](https://...)`
        - 비교와 요약은 마크다운 표를 적극 활용
        - 너무 복잡하지 않되, 전문적인 톤을 유지하며 친절하게 작성

        출력 예시:

        ---

        # 📄 사용자 맞춤형 공공정책 전략 보고서

        ## 1. 👤 사용자 질문 및 프로필
        - **질문:** 서울 거주 청년이 받을 수 있는 취업 지원이 있을까요?
        - **프로필 요약:**
        - 나이: **29세**
        - 지역: **서울**
        - 관심 분야: **취업**
        - 소득 수준: 중위소득 120%

        ## 2. 🔍 추천된 정책 리스트 상세 내용
        1. **청년 면접수당 지원사업**
        - 면접 시 1회 **5만원** 지원
        - **장점:** 간단한 조건, 빠른 신청 가능
        - **주의사항:** 면접 일정이 있어야 신청 가능
        - [신청 바로가기](https://gov.kr/1)
        2. **취업날개 서비스**
        - 정장 무료 대여
        - **장점:**
        - **주의사항:**
        - [신청 바로가기](https://...)
        3. **서울 청년수당**
        - 월 **50만원**, 최대 **6개월** 지원
        - **장점:**
        - **주의사항:**
        - [신청 바로가기](https://...)

        ## 3. 📊 정책 비교 분석
        | 항목 | 청년 면접수당 | 취업날개 서비스 | 서울 청년수당 |
        |------|----------------|------------------|----------------|
        | 지원 대상 | 서울시 미취업 청년 | 서울시 거주 청년 | 중위소득 150% 이하 청년 |
        | 금액 | 1회 5만원 | 정장 대여 (연 10회) | 월 50만원 (최대 6개월) |
        | 신청 링크 | [바로가기](https://gov.kr/1) | [바로가기](https://gov.kr/2) | [바로가기](https://gov.kr/3) |

        ### 추천 정책: **서울 청년수당**
        **추천 이유:** 정기적인 지원금으로 안정적인 구직 준비에 도움이 됩니다.

         ## 4. 🧭 실행 전략 (신청 순서 및 이유)
        **1단계. 청년 면접수당 신청**
        - 먼저 서울청년포털에 회원가입하세요.
        - 이후 [서비스 신청 페이지](https://example.com/1)에 접속해 쿠폰을 신청합니다.
        - 문자를 받은 후 제휴 미용실에 예약하여 정장을 대여할 수 있어요.

        ...

        ## 5. 📊 신청 조건 요약표
        | 정책명 | 나이 조건 | 소득 조건 | 신청 주기 | 기타 조건 |
        |--------|------------|-------------|-------------|--------------|
        | 청년수당 | 만 19~34세 | 중위소득 150% 이하 | 연 1회 | 미취업 상태 |
        | 면접수당 | 만 19~34세 | 무관 | 회당 신청 | 면접 일정 필요 |
        ...

        ## 6. 🧾 결론 및 마무리 조언
        > 현재 상황에서 위 정책들을 순차적으로 활용하면, 실질적인 취업 준비와 경제적 지원을 함께 받을 수 있습니다.
        > 신청 기간을 꼭 확인하시고, 바로 실행해보세요! 응원합니다 💪

        ---
        """
        ),
        agent=agent,
        output_key="final_report",
        result_as_dict=True,
    )
